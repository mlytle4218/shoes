<!DOCTYPE html>
<html lang="en">

<head>
	<title>three.js webgl - post processing - Scalable Ambient Occlusion (SAO)</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<style>
		body {
			background-color: #000000;
			margin: 0px;
			overflow: hidden;
			font-family: Monospace;
			font-size: 13px;
			text-align: center;
			font-weight: bold;
		}

		a {
			color: #00ff78;
		}

		#info {
			color: #fff;
			position: absolute;
			top: 0px;
			width: 100%;
			padding: 5px;
		}

		.dg.ac {
			z-index: 1 !important;
			/* FIX DAT.GUI */
		}
	</style>
</head>

<body>
	<script src="js/three.js"></script>

	<script src="js/EffectComposer.js"></script>
	<script src="js/RenderPass.js"></script>
	<script src="js/ShaderPass.js"></script>
	<script src="js/SAOPass.js"></script>

	<script src="js/CopyShader.js"></script>
	<script src="js/SAOShader.js"></script>
	<script src="js/DepthLimitedBlurShader.js"></script>
	<script src="js/UnpackDepthRGBAShader.js"></script>
	<script src="js/OBJLoader.js"></script>
	<script src="js/MTLLoader.js"></script>
	<script src="js/OrbitControls.js"></script>

	<script src="js/WebGL.js"></script>
	<!-- <script src="js/stats.min.js"></script> -->
	<script src='js/dat.gui.min.js'></script>

	<div id="info">
		<a href="http://threejs.org" target="_blank" rel="noopener noreferrer">three.js</a> - Scalable Ambient Occlusion
		(SAO) shader by <a href="http://clara.io">Ben Houston</a> / Post-processing pass by <a href="http://ludobaka.github.io">Ludobaka</a>
	</div>

	<script>
		if (WEBGL.isWebGLAvailable() === false) {

			document.body.appendChild(WEBGL.getWebGLErrorMessage());

		}

		var container, stats;
		var camera, scene, renderer;
		var composer, renderPass, saoPass;
		var group;
		var controls;

		init();
		animate();

		function init() {

			container = document.createElement('div');
			// document.body.appendChild(container);

			var width = window.innerWidth || 1;
			var height = window.innerHeight || 1;
			var devicePixelRatio = window.devicePixelRatio || 1;

			renderer = new THREE.WebGLRenderer({
				antialias: true
			});
			renderer.setClearColor(0x000000);
			renderer.setPixelRatio(devicePixelRatio);
			renderer.setSize(width, height);
			document.body.appendChild(renderer.domElement);

			camera = new THREE.PerspectiveCamera(65, width / height, 3, 1000);
			camera.position.z = 50;

			controls = new THREE.OrbitControls(camera, render.domElement);
			controls.target.set(0, 5, 0);
			// the max and min zoom here
			controls.maxDistance = 50;
			controls.minDistance = 10;
			controls.update();

			scene = new THREE.Scene();

			var color = new THREE.Color(0xffffff);
			scene.background = color;


			// var light = new THREE.PointLight(0xddffdd, 0.8);
			// light.position.z = 70;
			// light.position.y = -70;
			// light.position.x = -70;
			// scene.add(light);

			// var light2 = new THREE.PointLight(0xffdddd, 0.8);
			// light2.position.z = 70;
			// light2.position.x = -70;
			// light2.position.y = 70;
			// scene.add(light2);

			// var light3 = new THREE.PointLight(0xddddff, 0.8);
			// light3.position.z = 70;
			// light3.position.x = 70;
			// light3.position.y = -70;
			// scene.add(light3);

			// var light3 = new THREE.AmbientLight(0xffffff, 0.05);
			// scene.add(light3);

			// setting the ambient light for the model
			var ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
			scene.add(ambientLight);

			// setting the point light that stays with the camera
			var pointLight = new THREE.PointLight(0x999999, 0.05, 100, 1);
			pointLight.position.set(0, 0, -1).normalize();
			pointLight.castShadow = true;
			camera.add(pointLight);

			// setting a directional light directly over the model to light and cast shadows
			var directionalLight = new THREE.SpotLight(0xffffff);
			directionalLight.position.set(0, 40, 0);
			directionalLight.castShadow = true;

			//Set up shadow properties for the light
			directionalLight.shadow.mapSize.width = 512; // default
			directionalLight.shadow.mapSize.height = 512; // default
			directionalLight.shadow.camera.near = 0.5; // default
			directionalLight.shadow.camera.far = 500; // default
			directionalLight.shadow.camera = new THREE.OrthographicCamera(-75, 75, 75, -75, 0.5, 1000);
			scene.add(directionalLight);

			// add the camera so the pointlight following the camera will work
			scene.add(camera);








			var envMap = new THREE.CubeTextureLoader().load([
				'pics/posx.jpg',
				'pics/negx.jpg',
				'pics/posy.jpg',
				'pics/negy.jpg',
				'pics/posz.jpg',
				'pics/negz.jpg'
			])


			var json = {
				"fab": "splits/makeItRain_f.obj",
				"shiny": "splits/makeItRain_s.obj",
				"diffuse": "_KT4_MiR_diffuse.jpg",
				"rough": "_KT4_0_rough.jpg",
				"normal": "_KT4_MiR_NML.jpg"
			}


			var progress = console.log;
			var err = console.error;

			mtl_loader = new THREE.MTLLoader();
			var matS = mtl_loader.loadNewS(json.diffuse, json.normal, json.rough);
			var matF = mtl_loader.loadNewF(json.diffuse, json.normal, json.rough);

			console.log(matS);
			matS.preload();
			matF.preload();



			var obj_loader = new THREE.OBJLoader();
			obj_loader.setMaterials(matS);
			obj_loader.load(json.shiny,
				function (shiny) {
					shiny.children[0].material.envMap = envMap;
					shiny.children[0].material.roughness = 0.2;
					model = shiny;
					console.log(shiny);

					obj_loader.setMaterials(matF);
					obj_loader.load(json.fab,
						function (fabric) {
							fabric.children[0].material.envMap = envMap;
							fabric.children[0].material.roughness = 0.8;
							model2 = fabric;
							shiny.add(fabric)
							scene.add(shiny);
							addGui();
						}, progress, err
					)
				}, progress, err
			)































			// var geometry = new THREE.SphereBufferGeometry( 3, 48, 24 );

			// for ( var i = 0; i < 120; i ++ ) {

			// 	var material = new THREE.MeshStandardMaterial();
			// 	material.roughness = 0.5 * Math.random() + 0.25;
			// 	material.metalness = 0;
			// 	material.color.setHSL( Math.random(), 1.0, 0.3 );

			// 	var mesh = new THREE.Mesh( geometry, material );
			// 	mesh.position.x = Math.random() * 4 - 2;
			// 	mesh.position.y = Math.random() * 4 - 2;
			// 	mesh.position.z = Math.random() * 4 - 2;
			// 	mesh.rotation.x = Math.random();
			// 	mesh.rotation.y = Math.random();
			// 	mesh.rotation.z = Math.random();

			// 	mesh.scale.x = mesh.scale.y = mesh.scale.z = Math.random() * 0.2 + 0.05;
			// 	group.add( mesh );

			// }

			// stats = new Stats();
			// container.appendChild( stats.dom );

			composer = new THREE.EffectComposer(renderer);
			renderPass = new THREE.RenderPass(scene, camera);
			composer.addPass(renderPass);
			saoPass = new THREE.SAOPass(scene, camera, false, true);
			saoPass.renderToScreen = true;
			composer.addPass(saoPass);

			// Init gui
			// var gui = new dat.GUI();
			// gui.add(saoPass.params, 'output', {
			// 	'Beauty': THREE.SAOPass.OUTPUT.Beauty,
			// 	'Beauty+SAO': THREE.SAOPass.OUTPUT.Default,
			// 	'SAO': THREE.SAOPass.OUTPUT.SAO,
			// 	'Depth': THREE.SAOPass.OUTPUT.Depth,
			// 	'Normal': THREE.SAOPass.OUTPUT.Normal
			// }).onChange(function (value) {

			// 	saoPass.params.output = parseInt(value);

			// });






			window.addEventListener('resize', onWindowResize, false);

		}

		function addGui(){
			var params = {
				ambientColor: '#ffffff'
			}
			var gui = new dat.GUI();
			var ambient = gui.addFolder('Ambient Light');
			ambient.addColor(params, 'ambientColor', 0, 1).onChange(function () {
				var tempColor = new THREE.Color(params.ambientColor);
				scene.children[0].color = new THREE.Color(tempColor.getStyle());
			});
			ambient.add(scene.children[0], 'intensity', 0, 1).listen();

			var point = gui.addFolder('Point Light');
			point.addColor(params, 'ambientColor', 0, 1).onChange(function () {
				var tempColor = new THREE.Color(params.ambientColor);
				scene.children[1].color = new THREE.Color(tempColor.getStyle());
			});
			point.add(scene.children[1], 'intensity', 0, 1).listen();

			var directional = gui.addFolder('Directional Light');
			directional.addColor(params, 'ambientColor', 0, 1).onChange(function () {
				var tempColor = new THREE.Color(params.ambientColor);
				scene.children[2].children[0].color = new THREE.Color(tempColor.getStyle());
			});
			directional.add(scene.children[2].children[0], 'intensity', 0, 1).listen();

			var fabric = gui.addFolder('Fabric Model');
			fabric.add(scene.children[3].children[1].children[0].material, 'roughness', 0, 1).listen();
			fabric.add(scene.children[3].children[1].children[0].material, 'bumpScale', 0, 1).listen();
			fabric.add(scene.children[3].children[1].children[0].material, 'metalness', 0, 1).listen();

			var shiny = gui.addFolder('Shiny Model');
			shiny.add(scene.children[3].children[0].material, 'roughness', 0, 1).listen();
			shiny.add(scene.children[3].children[0].material, 'bumpScale', 0, 1).listen();
			shiny.add(scene.children[3].children[0].material, 'metalness', 0, 1).listen();


			var sao = gui.addFolder('AO');
			sao.add(saoPass.params, 'saoBias', -1, 1);
			sao.add(saoPass.params, 'saoIntensity', 0, 1);
			sao.add(saoPass.params, 'saoScale', 0, 10);
			sao.add(saoPass.params, 'saoKernelRadius', 1, 100);
			sao.add(saoPass.params, 'saoMinResolution', 0, 1);
			sao.add(saoPass.params, 'saoBlur');
			sao.add(saoPass.params, 'saoBlurRadius', 0, 200);
			sao.add(saoPass.params, 'saoBlurStdDev', 0.5, 150);
			sao.add(saoPass.params, 'saoBlurDepthCutoff', 0.0, 0.1);
		}

		function onWindowResize() {

			var width = window.innerWidth || 1;
			var height = window.innerHeight || 1;

			camera.aspect = width / height;
			camera.updateProjectionMatrix();
			renderer.setSize(width, height);

			composer.setSize(width, height);


		}

		function animate() {

			requestAnimationFrame(animate);

			// stats.begin();
			render();
			// stats.end();

		}

		function render() {

			var timer = performance.now();

			composer.render();

		}
	</script>
</body>

</html>
